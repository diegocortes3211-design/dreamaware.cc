tasks:
  - id: ensure_gnn
    cmd: bash scripts/ensure_gnn.sh
  - id: patch_gnn_features
    depends: [ensure_gnn]
    cmd: |
      python - <<'PY'
      import io, re, sys, pathlib
      p = pathlib.Path("services/secfold/gnn_train.py")
      s = p.read_text()
      # Replace ONLY the dummy feature line with your real builder call if present
      s2 = re.sub(r"x\s*=\s*torch\.rand\([^)]*\)", "x = build_node_features(seq[:-1], self.node_map)", s)
      if s2 != s:
          p.write_text(s2)
          print("Patched feature builder in gnn_train.py")
      else:
          print("No patch applied (pattern not found).")
      PY
  - id: run_gnn_ci
    depends: [patch_gnn_features]
    cmd: |
      (pytest -q tests/secfold/test_feature_utils.py || echo "skip feature utils tests") &&
      python services/secfold/gnn_train.py
  - id: reviewscore:assess
    cmd: python services/evaluation/reviewscore.py
    env:
      HF_MODEL:    "ReviewScore-v1"
      INPUT_DIR:   "data/reviews/incoming"
      OUTPUT_FILE: "reports/reviewscore.jsonl"