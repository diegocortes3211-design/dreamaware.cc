tasks:
  - id: ensure_gnn
    cmd: bash scripts/ensure_gnn.sh
  - id: patch_gnn_features
    depends: [ensure_gnn]
    cmd: |
      python - <<'PY'
      import io, re, sys, pathlib
      p = pathlib.Path("services/secfold/gnn_train.py")
      s = p.read_text()
      # Replace ONLY the dummy feature line with your real builder call if present
      s2 = re.sub(r"x\s*=\s*torch\.rand\([^)]*\)", "x = build_node_features(seq[:-1], self.node_map)", s)
      if s2 != s:
          p.write_text(s2)
          print("Patched feature builder in gnn_train.py")
      else:
          print("No patch applied (pattern not found).")
      PY
  - id: run_gnn_ci
    depends: [patch_gnn_features]
    cmd: |
      (pytest -q tests/secfold/test_feature_utils.py || echo "skip feature utils tests") &&
      python services/secfold/gnn_train.py
  - id: gym:ucapi_fuzz
    cmd: pytest -q tools/fuzz/ucapi_fuzz.py || true
  - id: gym:failures_tail
    cmd: bash -lc 'ls -1rt reports/failures | tail -n 5 | xargs -I{} sh -c "echo ==== {}; cat reports/failures/{}"'
  - id: score:creativity_demo
    cmd: |
      python - <<'PY'
      from services.score.creativity import creativity_score
      s = "def fib(n): a,b=0,1\n while n>0: a,b=b,a+b; n-=1\n return a"
      print("creativity:", creativity_score(s))
      PY
  - id: score:elo_demo
    cmd: |
      python - <<'PY'
      from services.score.elo import update_elo
      print(update_elo(1500,1500,1.0))
      PY